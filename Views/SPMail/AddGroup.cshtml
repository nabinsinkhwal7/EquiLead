@using Microsoft.AspNetCore.Http;
@model SPMAilCommonModel
@{
    ViewData["Title"] = "Groups";

    Layout = "~/Views/Shared/_LayoutAdminLTEAdmin.cshtml";

    var edit = TempData["EditRight"] == null ? false : (bool)TempData["EditRight"];
    TempData.Keep("EditRight");
    var delete = TempData["DeleteRight"] == null ? false : (bool)TempData["DeleteRight"];
    TempData.Keep("DeleteRight");
    var add = TempData["AddRight"] == null ? false : (bool)TempData["AddRight"];
    TempData.Keep("AddRight");

}
<style>
    .card {
        position: relative;
        display: -ms-flexbox;
        display: flex;
        -ms-flex-direction: column;
        flex-direction: column;
        min-width: 0;
        word-wrap: break-word;
        background-color: #fff;
        background-clip: border-box;
        border: 0px solid #72def6;
        border-radius: .25rem;
    }

    .bgButton {
        background: #bfd600 !important;
        border-color: #bfd600 !important;
    }

        .bgButton:hover {
            background: #b2c607 !important;
            border-color: #b2c607 !important;
        }


    .bgbagheader {
        background: #b9f2ff; /* Old browsers */
    }

    .dataTables_length {
        margin-left: 10px;
    }

    .btn-orang {
        color: #fff;
        background-color: #f39c12;
        border-color: #f39c12;
    }

        .btn-orang:hover {
            color: #fff;
            background-color: #fe8936;
            border-color: #fe8936;
        }

    .buttons-html5 {
        background-color: #4CAF50 !important; /* Green */
        border: none !important;
        color: white !important;
        text-align: center !important;
        text-decoration: none !important;
        display: inline-block !important;
        padding: 5px;
        margin: 2px;
    }
</style>


<form method="post" enctype="multipart/form-data">
    <section id="AboutSection" class="mt-4 mb-4" style="padding:15px;text-transform: uppercase; font-size: 14px; letter-spacing: 0.1rem;">

        <div class="row">
            <div class="col-xl-4 col-lg-4 col-md-4 col-sm-12 col-xs-12">
                <h2 class="PagemainHeading text-center">
                    Group's
                </h2>
            </div>
            <div class="col-xl-4 col-lg-4 col-md-4 col-sm-12 col-xs-12">

            </div>
            <div class="col-xl-4 col-lg-4 col-md-4 col-sm-12 col-xs-12">
                <div class="pull-right">
                    @if (add)
                    {
                        <a href="#" class="btn btn-info mt-2" data-toggle="modal" data-target="#ModalSaveGroup" onclick="setGRPId('0','I');"><i class="fa fa-plus" aria-hidden="true"></i>&nbsp;Add Group</a>
                    }

                </div>
            </div>
        </div>
        <div class="row">
            <div class="col-xl-12 col-lg-12 col-md-12 col-sm-12 col-xs-12" id="DVContactTable">
                <table id="tblGroupList" class="table table-hover table-striped datatablerowfont">
                    <thead>
                        <tr style="font-size:14px">
                            <th>SR.No</th>
                            <th>Group Name</th>
                            <th># Member/School</th>
                            <th>Link School</th>
                            <th>Link Contact</th>
                            <th>Action</th>

                        </tr>
                    </thead>
                    <tbody>
                        @foreach (var LRF in Model.LSTContactGroup)
                        {
                        <tr style="font-size:14px" title="" id="@LRF.ContactGroupId">
                            <td><b> @( ((Int32)1) + Model.LSTContactGroup.IndexOf(LRF) )</b> </td>


                            <td class="mailbox-name"> @LRF.GroupName</td>
                            @if (Model.LSTContacgGrpMapping.Where(p => p.ContactGroupId == @LRF.ContactGroupId).Select(p => p.IsSchoolList).FirstOrDefault() == true)
                            {
                        <td class="mailbox-name"> @Model.LSTContacgGrpMapping.Where(p => p.ContactGroupId == @LRF.ContactGroupId).Count()&nbsp; &nbsp;<i class="fa fa-university  text-info"></i></td>
                            }
                            else
                            {
                        <td class="mailbox-name"> @Model.LSTContacgGrpMapping.Where(p => p.ContactGroupId == @LRF.ContactGroupId).Count()&nbsp; &nbsp;<i class="fa fa-users  text-info"></i></td>
                            }

                            <td>

                                <a href="#" style="margin: 0px 0px 0px 10px;" onclick="getselectedlist(@LRF.ContactGroupId,'SCH')" title="Link"><i class="fa fa-plus text-info"></i></a>
                            </td>
                            <td>
                                <a href="#" style="margin: 0px 0px 0px 10px;" onclick="getselectedlist(@LRF.ContactGroupId,'MEM')" title="Link"><i class="fa fa-plus text-info"></i></a>
                            </td>
                            <td>
                                @if (edit)
                                {
                                    <a href="#" style="margin: 0px 0px 0px 10px;" data-toggle="modal" data-target="#ModalSaveGroup" onclick="setGRPId(@LRF.ContactGroupId,'U')" title="Compose Mail"><i class="fa fa-pencil text-dark"></i></a>
                                }
                                @if (delete)
                                {
                                    <a href="#" style="margin: 0px 0px 0px 10px;" onclick="RemoveGroupId(@LRF.ContactGroupId)" title="Remove"><i class="fa fa-trash text-danger"></i></a>
                                }
                            </td>

                        </tr>
                        }
                    </tbody>
                </table>
            </div>

        </div>

    </section>
    @*modal for SaveGroup*@
    <div id="ModalSaveGroup" class="modal fade" tabindex="-1" role="dialog"
         aria-hidden="true" data-keyboard="false" data-backdrop="static">
        <div class="modal-dialog modal-md">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 style="font-weight:600">Add Group</h5>
                    <button type="button" class="close" data-dismiss="modal">&times;</button>
                </div>
                <div class="modal-body p-4">
                    <div class="row">
                        <div class="col-xl-12 col-lg-12 col-md-12 col-sm-12">
                            <div class="form-group">
                                <label class="control-label">Name </label><span class="mandatory text-danger"> *</span>
                                <input id="txtGroupname" required maxlength="150" class="form-control" />
                            </div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <div class="pull-right">
                        <input onclick="SaveGRP();" class="btn btn-orang mt-3" value="Save " />
                    </div>
                </div>
            </div>
            <!-- /.modal-content -->
        </div>
        <!-- /.modal-dialog -->
    </div>

    <div id="ModalshowSchoolMmberList" class="modal fade" tabindex="-1" role="dialog"
         aria-hidden="true" data-keyboard="false" data-backdrop="static">
        <div class="modal-dialog modal-lg">
            <div class="modal-content" id="DVLINKLIST">
                
            </div>

            <!-- /.modal-content -->
        </div>
        <!-- /.modal-dialog -->
    </div>

    <input type="hidden" id="hdaddgroupflag" />
    <input type="hidden" id="hdgroupId" />
</form>


     

<script>

    $(function () {
        $('#tblGroupList').DataTable({
            dom: 'lBfrtip',
            buttons: [
                'excelHtml5',
                'pdf'
            ],
            'paging': true,
            'lengthChange': false,
            "scrollX": true,
            'searching': true,
            'ordering': true,
            'info': true,
            'autoWidth': false

        })

        $('#tblContactList').DataTable({

            'paging': false,
            'lengthChange': false,
            "scrollX": true,
            'searching': true,
            'ordering': true,
            'info': true,
            'autoWidth': false

        })

        //$('#selectAll').click(function (e) {
        //    $(this).closest('table').find('td input:checkbox').prop('checked', this.checked);
        //});
    })

    function checkAll(ele) {
        var checkboxes = document.getElementsByTagName('input');
        if (ele.checked) {
            for (var i = 0; i < checkboxes.length; i++) {
                if (checkboxes[i].type == 'checkbox') {
                    checkboxes[i].checked = true;
                }
            }
        } else {
            for (var i = 0; i < checkboxes.length; i++) {
                console.log(i)
                if (checkboxes[i].type == 'checkbox') {
                    checkboxes[i].checked = false;
                }
            }
        }
    }

    function getselectedlist(Contactgroupid,Flag) {
        debugger;
        //DVLINKLIST
        $('#hdgroupId').val(Contactgroupid);
        var p = { "GroupId": Contactgroupid, "flag": Flag };

                $.ajax({
                    url: "@Url.Action("FillGroupContent", "SPMail")", //Your path should be here
                    type: "POST",
                    data: p,
                    success: function (result) {

                        $('#DVLINKLIST').html(result);
                        $('#ModalshowSchoolMmberList').modal('toggle');
                       

                    },
                    error: function (xhr, status, error) {
                        var err = eval("(" + xhr.responseText + ")");
                        alert(err.Message);
                    }
                });


    }

    function SaveGRP() {

        var p = { "Groupname": $('#txtGroupname').val(), "flag": $('#hdaddgroupflag').val(), "groupId": $('#hdgroupId').val() };
                $.ajax({
                    url: "@Url.Action("SaveGroup", "SPMail")",
                    type: "POST",
                    data: p,
                    success: function (result) {
                        debugger;
                        $('#ModalSaveGroup').modal('toggle');
                        $('#DVContactTable').html(result);

                        if ($('#hdaddContactflag').val() == 'I') {
                            $.bootstrapGrowl("<i class='fa fa-check-circle' aria-hidden='true'></i> Group save successfully.", {
                                type: 'info',
                                align: 'center',
                                width: 'auto',
                                allow_dismiss: true,
                                delay: 5000
                            });
                        }
                        else {
                            $.bootstrapGrowl("<i class='fa fa-check-circle' aria-hidden='true'></i> Group update successfully.", {
                                type: 'info',
                                align: 'center',
                                width: 'auto',
                                allow_dismiss: true,
                                delay: 5000
                            });
                        }
                    },
                    error: function (xhr, status, error) {
                        var err = eval("(" + xhr.responseText + ")");
                        alert(err.Message);
                    }
                });

    }

    function setGRPId(GroupId,flag)
    {
        $('#hdgroupId').val(GroupId);
        $('#hdaddgroupflag').val(flag);

            if (flag == 'I') {

                $('#txtGroupname').val('');

            }
            else
            {
                var p = { "GroupId": GroupId, };

                $.ajax({
                    url: "@Url.Action("FillGroup", "SPMail")", //Your path should be here
                    type: "POST",
                    data: p,
                    success: function (result) {

                        $('#txtGroupname').val(result[0].GroupName);

                    },
                    error: function (xhr, status, error) {
                        var err = eval("(" + xhr.responseText + ")");
                        alert(err.Message);
                    }
                });
            }
        }

    function RemoveGroupId(GroupId)
    {

        var p = { "GroupId": GroupId, };

                $.ajax({
                    url: "@Url.Action("RemoveGroup", "SPMail")", //Your path should be here
                    type: "POST",
                    data: p,
                    success: function (result) {

                        $('#DVContactTable').html(result);

                        $.bootstrapGrowl("<i class='fa fa-check-circle' aria-hidden='true'></i> Contact remove successfully.", {
                                type: 'info',
                                align: 'center',
                                width: 'auto',
                                allow_dismiss: true,
                                delay: 5000
                            });




                    },
                    error: function (xhr, status, error) {
                        var err = eval("(" + xhr.responseText + ")");
                        alert(err.Message);
                    }
                });

    }

    function LinkGroup(flag) {
         var formdata = [];

         debugger;
         $('input:checkbox').each(function () {
             if ($(this).is(':checked')) {
                 if ($(this).val() != 'yes') {

                     formdata.push({
                         Suid: $(this).val()
                     });
                 }
                 
             }

         });

        formdata = JSON.stringify(formdata);
         
        var p = { "MemselectedItems": formdata, "ContactGroupId": $('#hdgroupId').val(), "flag": flag};

          $.ajax({
              url: "@Url.Action("LinkMember", "SPMail")", //Your path should be here
            type: "POST",
            data: p,
            success: function (result) {

                $('#DVContactTable').html(result);
                $('#ModalshowSchoolMmberList').modal('toggle');
            },
            error: function (xhr, status, error) {
                var err = eval("(" + xhr.responseText + ")");
                alert(err.Message);
            }
            });

    }
</script>
